---
title: "Task3"
output: html_document
date: "2022-11-11"
---

Прочитаем и обработаем данные. Среди данных не может быть отрицательных значений, 
NA обозначаются как -999.
```{r, message=FALSE, warning=FALSE}
library(readxl)
library(dplyr)
library(tidyr)
```

```{r, message=FALSE, warning=FALSE}
df <- read_excel("Sleep/SLEEP_shortname.xls")
df[df < 0] <- NA

head(df)
length(df$NAME)
```
Посмотрим на данные.
```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(GGally)
```

```{r, message=FALSE, warning=FALSE}
df %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), 
          columns = c("BODY_WEI", "BRAIN_WE", "SLEEP", "LIFESPAN", "GESTTIME"))
```
Преобразуем данные. Переведем вес животного в граммы, продолжительность жизни в
дни. Логарифмируем данные, чтобы было легче наблюдать корреляции (выше заметны 
сильно отличающиеся индивиды, это слоны). Факторизуем индексы.
```{r}
dfNew <- df %>% mutate(PRED_IND = as.factor(PRED_IND), EXP_IND = as.factor(EXP_IND),
                   DANG_IND = as.factor(DANG_IND), 
                   BODY_WEI = log(BODY_WEI * 1000), BRAIN_WE = log(BRAIN_WE), 
                   LIFESPAN = log(LIFESPAN * 365.25), GESTTIME = log(GESTTIME))
```
Посмотрим на новые данные. Сгруппируем индивидов по факторам. 
```{r, message=FALSE, warning=FALSE}
dfNew %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), 
          columns = c("BODY_WEI", "BRAIN_WE", "SLEEP", "LIFESPAN", "GESTTIME"))
dfNew %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), aes(colour=PRED_IND), legend=1,
          columns=c("BODY_WEI", "BRAIN_WE", "SLEEP", "LIFESPAN", "GESTTIME"))
dfNew %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), aes(colour=EXP_IND), legend=1,
          columns=c("BODY_WEI", "BRAIN_WE", "SLEEP", "LIFESPAN", "GESTTIME"))
dfNew %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), aes(colour=DANG_IND), legend=1,
          columns=c("BODY_WEI", "BRAIN_WE", "SLEEP", "LIFESPAN", "GESTTIME"))
```
Посмотрим на корреляции между признаками.
```{r, warning=FALSE, message = FALSE}
library(reshape)
```

```{r, warning=FALSE, message = FALSE}
dplyr::select(dfNew, -NAME) %>%
mutate(PRED_IND = as.numeric(PRED_IND), EXP_IND = as.numeric(EXP_IND), DANG_IND = as.numeric(DANG_IND)) %>%
cor(method = "pearson", use = "pairwise.complete.obs") %>%
melt() %>%
ggplot(aes(X1, X2)) +
  geom_raster(aes(fill = value)) +
  geom_text(aes(label = round(value, 3))) +
  scale_fill_gradient2(low=colors()[555], mid=colors()[1], high=colors()[26]) + 
  ggtitle("dfNew pearson") +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))

dplyr::select(dfNew, -NAME) %>%
mutate(PRED_IND = as.numeric(PRED_IND), EXP_IND = as.numeric(EXP_IND), DANG_IND = as.numeric(DANG_IND)) %>%
cor(method = "spearman", use = "pairwise.complete.obs") %>%
melt() %>%
ggplot(aes(X1, X2)) +
  geom_raster(aes(fill = value)) +
  geom_text(aes(label = round(value, 3))) +
  scale_fill_gradient2(low=colors()[555], mid=colors()[1], high=colors()[26]) + 
  ggtitle("dfNew spearman") +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))
  
```
Опишем разницу между животными по степени опасности места, где
они спят.
```{r, warning=FALSE, message = FALSE}
dfNew %>% ggplot(aes(y=BODY_WEI, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=BRAIN_WE, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=SLOWWAVE, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=PARADOX, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=SLEEP, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=LIFESPAN, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=GESTTIME, colour=EXP_IND)) + geom_boxplot()
```
Можно заметить, что животные живущие в более защищенных местах 1,2) имеют меньший
вес тела и мозга; 3,4,5) дольше спят в общем и в разных фазах сна по отдельности;
6,7) имеют менее длительные продолжительность жизни и период вынашивания потомства. 
Проверим это с помощью критериев.

Используем Welch-test, так как выборки независимые и нам не известны дисперсии.
```{r}
dfNew1 <- dplyr::filter(dfNew, EXP_IND == 1)
dfNew2 <- dplyr::filter(dfNew, EXP_IND == 2)
dfNew3 <- dplyr::filter(dfNew, EXP_IND == 3)
dfNew4 <- dplyr::filter(dfNew, EXP_IND == 4)
dfNew5 <- dplyr::filter(dfNew, EXP_IND == 5)
```

```{r}
t.test(dfNew1$BODY_WEI, dfNew2$BODY_WEI, alternative="less")
t.test(dfNew1$BODY_WEI, dfNew3$BODY_WEI, alternative="less")
t.test(dfNew1$BODY_WEI, dfNew4$BODY_WEI, alternative="less")
t.test(dfNew1$BODY_WEI, dfNew5$BODY_WEI, alternative="less")

t.test(dfNew2$BODY_WEI, dfNew3$BODY_WEI, alternative="less")
t.test(dfNew2$BODY_WEI, dfNew4$BODY_WEI, alternative="less")
t.test(dfNew2$BODY_WEI, dfNew5$BODY_WEI, alternative="less")

t.test(dfNew3$BODY_WEI, dfNew4$BODY_WEI, alternative="less")
t.test(dfNew3$BODY_WEI, dfNew5$BODY_WEI, alternative="less")

t.test(dfNew4$BODY_WEI, dfNew5$BODY_WEI, alternative="less")
```
Потчти все гипотезы о равенстве мат. ожидание отверглись в пользу того, что
животное, которое спит в более защищенном месте весит меньше, с уровнем 
значимости 0.05.
```{r}
t.test(dfNew1$BRAIN_WE, dfNew2$BRAIN_WE, alternative="less")
t.test(dfNew1$BRAIN_WE, dfNew3$BRAIN_WE, alternative="less")
t.test(dfNew1$BRAIN_WE, dfNew4$BRAIN_WE, alternative="less")
t.test(dfNew1$BRAIN_WE, dfNew5$BRAIN_WE, alternative="less")

t.test(dfNew2$BRAIN_WE, dfNew3$BRAIN_WE, alternative="less")
t.test(dfNew2$BRAIN_WE, dfNew4$BRAIN_WE, alternative="less")
t.test(dfNew2$BRAIN_WE, dfNew5$BRAIN_WE, alternative="less")

t.test(dfNew3$BRAIN_WE, dfNew4$BRAIN_WE, alternative="less")
t.test(dfNew3$BRAIN_WE, dfNew5$BRAIN_WE, alternative="less")

t.test(dfNew4$BRAIN_WE, dfNew5$BRAIN_WE, alternative="less")
```
Если не учитывать животных, близких друг другу по значению EXP_IND, то потчти 
все гипотезы о равенстве мат. ожидание отверглись в пользу того, что животное, 
которое спит в более защищенном месте имеет меньший вес мозга, с уровнем 
значимости 0.05.
```{r}
t.test(dfNew1$SLOWWAVE, dfNew2$SLOWWAVE, alternative="greater")
t.test(dfNew1$SLOWWAVE, dfNew3$SLOWWAVE, alternative="greater")
t.test(dfNew1$SLOWWAVE, dfNew4$SLOWWAVE, alternative="greater")
t.test(dfNew1$SLOWWAVE, dfNew5$SLOWWAVE, alternative="greater")

t.test(dfNew2$SLOWWAVE, dfNew3$SLOWWAVE, alternative="greater")
t.test(dfNew2$SLOWWAVE, dfNew4$SLOWWAVE, alternative="greater")
t.test(dfNew2$SLOWWAVE, dfNew5$SLOWWAVE, alternative="greater")

t.test(dfNew3$SLOWWAVE, dfNew4$SLOWWAVE, alternative="greater")
t.test(dfNew3$SLOWWAVE, dfNew5$SLOWWAVE, alternative="greater")

t.test(dfNew4$SLOWWAVE, dfNew5$SLOWWAVE, alternative="greater")
```
Тесты подтверждают результаты, наблюдаемые на box-plot-ах. 
```{r}
t.test(dfNew1$PARADOX, dfNew2$PARADOX, alternative="greater")
t.test(dfNew1$PARADOX, dfNew3$PARADOX, alternative="greater")
t.test(dfNew1$PARADOX, dfNew4$PARADOX, alternative="greater")
t.test(dfNew1$PARADOX, dfNew5$PARADOX, alternative="greater")

t.test(dfNew2$PARADOX, dfNew3$PARADOX, alternative="greater")
t.test(dfNew2$PARADOX, dfNew4$PARADOX, alternative="greater")
t.test(dfNew2$PARADOX, dfNew5$PARADOX, alternative="greater")

t.test(dfNew3$PARADOX, dfNew4$PARADOX, alternative="greater")
t.test(dfNew3$PARADOX, dfNew5$PARADOX, alternative="greater")

t.test(dfNew4$PARADOX, dfNew5$PARADOX, alternative="greater")
```
Тесты подтверждают результаты, наблюдаемые на box-plot-ах. 
```{r}
t.test(dfNew1$SLEEP, dfNew2$SLEEP, alternative="greater")
t.test(dfNew1$SLEEP, dfNew3$SLEEP, alternative="greater")
t.test(dfNew1$SLEEP, dfNew4$SLEEP, alternative="greater")
t.test(dfNew1$SLEEP, dfNew5$SLEEP, alternative="greater")

t.test(dfNew2$SLEEP, dfNew3$SLEEP, alternative="greater")
t.test(dfNew2$SLEEP, dfNew4$SLEEP, alternative="greater")
t.test(dfNew2$SLEEP, dfNew5$SLEEP, alternative="greater")

t.test(dfNew3$SLEEP, dfNew4$SLEEP, alternative="greater")
t.test(dfNew3$SLEEP, dfNew5$SLEEP, alternative="greater")

t.test(dfNew4$SLEEP, dfNew5$SLEEP, alternative="greater")
```
Тесты подтверждают результаты, наблюдаемые на box-plot-ах. 
```{r}
t.test(dfNew1$LIFESPAN, dfNew2$LIFESPAN, alternative="less")
t.test(dfNew1$LIFESPAN, dfNew3$LIFESPAN, alternative="less")
t.test(dfNew1$LIFESPAN, dfNew4$LIFESPAN, alternative="less")
t.test(dfNew1$LIFESPAN, dfNew5$LIFESPAN, alternative="less")

t.test(dfNew2$LIFESPAN, dfNew3$LIFESPAN, alternative="less")
t.test(dfNew2$LIFESPAN, dfNew4$LIFESPAN, alternative="less")
t.test(dfNew2$LIFESPAN, dfNew5$LIFESPAN, alternative="less")

t.test(dfNew3$LIFESPAN, dfNew4$LIFESPAN, alternative="less")
t.test(dfNew3$LIFESPAN, dfNew5$LIFESPAN, alternative="less")

t.test(dfNew4$LIFESPAN, dfNew5$LIFESPAN, alternative="less")
```
Тесты подтверждают результаты, наблюдаемые на box-plot-ах. 
```{r}
t.test(dfNew1$GESTTIME, dfNew2$GESTTIME, alternative="less")
t.test(dfNew1$GESTTIME, dfNew3$GESTTIME, alternative="less")
t.test(dfNew1$GESTTIME, dfNew4$GESTTIME, alternative="less")
t.test(dfNew1$GESTTIME, dfNew5$GESTTIME, alternative="less")

t.test(dfNew2$GESTTIME, dfNew3$GESTTIME, alternative="less")
t.test(dfNew2$GESTTIME, dfNew4$GESTTIME, alternative="less")
t.test(dfNew2$GESTTIME, dfNew5$GESTTIME, alternative="less")

t.test(dfNew3$GESTTIME, dfNew4$GESTTIME, alternative="less")
t.test(dfNew3$GESTTIME, dfNew5$GESTTIME, alternative="less")

t.test(dfNew4$GESTTIME, dfNew5$GESTTIME, alternative="less")
```
Тесты подтверждают результаты, наблюдаемые на box-plot-ах. 

Опишем распределения признаков.
Изобразим гистограммы признаков на фоне плотности нормального распределения.
```{r, warning=FALSE, message = FALSE}

dfMelt <- dfNew %>% 
  select(-PRED_IND, -EXP_IND, - DANG_IND) %>% 
  as.data.frame(dfNew) %>% 
  melt(id.vars = "NAME")

ggplot(dfMelt, aes(x = value)) +
        geom_histogram(aes(y = ..density..)) +
        facet_wrap(~variable, scales = "free") +
        labs(x = "", y = "") +
        geom_line(aes(y = dnorm(value,
                      mean = tapply(value, variable, mean, na.rm = TRUE)[PANEL],
                      sd = tapply(value, variable, sd, na.rm = TRUE)[PANEL]
                      )), linetype = 1)
```
Изобразим выборочную функцию распредления признаков на фоне функции 
распределения нормального распределения.
```{r, warning=FALSE, message = FALSE}
ggplot(dfMelt, aes(x = value)) +
        stat_ecdf() +
        facet_wrap(~variable, scales = "free") +
        labs(x = "", y = "") +
        geom_line(aes(y = pnorm(value,
                      mean = tapply(value, variable, mean, na.rm = TRUE)[PANEL],
                      sd = tapply(value, variable, sd, na.rm = TRUE)[PANEL]
                      )), linetype = 1)
```
Можно заметить, что имеет место нормальность распределения признаков. Проверим
это с помощью признаков.

Используем критерий Колмогорова-Смирнова, так как распределения абсолютно 
непрерывны.
```{r}
ks.test(dfNew$BODY_WEI, "pnorm", mean = mean(dfNew$BODY_WEI, na.rm=TRUE), sd = sd(dfNew$BODY_WEI, na.rm=TRUE))
ks.test(dfNew$BRAIN_WE, "pnorm", mean = mean(dfNew$BRAIN_WE, na.rm=TRUE), sd = sd(dfNew$BRAIN_WE, na.rm=TRUE))
ks.test(dfNew$SLOWWAVE, "pnorm", mean = mean(dfNew$SLOWWAVE, na.rm=TRUE), sd = sd(dfNew$SLOWWAVE, na.rm=TRUE))
ks.test(dfNew$PARADOX, "pnorm", mean = mean(dfNew$PARADOX, na.rm=TRUE), sd = sd(dfNew$PARADOX, na.rm=TRUE))
ks.test(dfNew$SLEEP, "pnorm", mean = mean(dfNew$SLEEP, na.rm=TRUE), sd = sd(dfNew$SLEEP, na.rm=TRUE))
ks.test(dfNew$LIFESPAN, "pnorm", mean = mean(dfNew$LIFESPAN, na.rm=TRUE), sd = sd(dfNew$LIFESPAN, na.rm=TRUE))
ks.test(dfNew$GESTTIME, "pnorm", mean = mean(dfNew$GESTTIME, na.rm=TRUE), sd = sd(dfNew$GESTTIME, na.rm=TRUE))
```
Все тесты не отрецают, что признаки имеют нормальное распределение с уровнем 
значимости 0.5.
















