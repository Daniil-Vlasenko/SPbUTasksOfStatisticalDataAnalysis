---
title: "Task3"
output: html_document
date: "2022-11-11"
---

## Предварительный анализ данных.
1. Описание признаков присутствует в сопроводительном файле. Прочитаем данные. 
Среди данных не может быть отрицательных значений, NA обозначаются как -999.
```{r, message=FALSE, warning=FALSE}
library(readxl)
library(dplyr)
library(tidyr)
```

```{r, message=FALSE, warning=FALSE}
df <- read_excel("Sleep/SLEEP_shortname.xls")
df[df < 0] <- NA

head(df)
```
Количество строк в таблице.
```{r}
nrow(df)
```

2. Признаков немного, поэтому рассматривать будем все.
3. Кроме индексов-факторов, все признаки количественные. Индексы - порядковые признаки.
Все количественные признаки непрерывные, но можно заметить дискретизацию при округлении.
Проверим это, посмотрев на частоты мод.
```{r}
find_mode <- function(x) {
  x <- x[!is.na(x)]
  u <- unique(x)
  tab <- tabulate(match(x, u))
  c(u[tab == max(tab)],  max(tab))
}

find_mode(df$BODY_WEI)
find_mode(df$BRAIN_WE)
find_mode(df$SLOWWAVE)
find_mode(df$PARADOX)
find_mode(df$SLEEP)
find_mode(df$LIFESPAN)
find_mode(df$GESTTIME)
```
Функция выводит моды (если их несколько), потом частоту. Видно, что проблемы 
с округлением есть.

4. Не актуально для текущих данных.
5. Посмотрим на данные.
```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(GGally)
```

```{r, message=FALSE, warning=FALSE}
df %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), 
          columns = c("BODY_WEI", "BRAIN_WE", "SLOWWAVE", "PARADOX", "SLEEP", "LIFESPAN", "GESTTIME"))
```
6. Преобразуем данные. Переведем вес животного в граммы, продолжительность жизни в
дни. Логарифмируем данные, чтобы было легче наблюдать корреляции (выше заметны 
сильно отличающиеся индивиды, это слоны). Факторизуем индексы.
```{r}
dfNew <- df %>% mutate(PRED_IND = as.factor(PRED_IND), EXP_IND = as.factor(EXP_IND),
                   DANG_IND = as.factor(DANG_IND), 
                   BODY_WEI = log(BODY_WEI * 1000), BRAIN_WE = log(BRAIN_WE), 
                   LIFESPAN = log(LIFESPAN * 365.25), GESTTIME = log(GESTTIME))
```
Посмотрим на новые данные. Сгруппируем индивидов по факторам. 
```{r, message=FALSE, warning=FALSE}
dfNew %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), 
          columns = c("BODY_WEI", "BRAIN_WE", "SLOWWAVE", "PARADOX", "SLEEP", "LIFESPAN", "GESTTIME"))
dfNew %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), aes(colour=PRED_IND), legend=1,
          columns=c("BODY_WEI", "BRAIN_WE", "SLOWWAVE", "PARADOX", "SLEEP", "LIFESPAN", "GESTTIME"))
dfNew %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), aes(colour=EXP_IND), legend=1,
          columns=c("BODY_WEI", "BRAIN_WE", "SLOWWAVE", "PARADOX", "SLEEP", "LIFESPAN", "GESTTIME"))
dfNew %>% dplyr::select(-NAME) %>%
  ggpairs(diag=list(continuous = "barDiag"), aes(colour=DANG_IND), legend=1,
          columns=c("BODY_WEI", "BRAIN_WE", "SLOWWAVE", "PARADOX", "SLEEP", "LIFESPAN", "GESTTIME"))
```
7. Аутлайнеров нет.
8. Неоднородности нет.
9. Не актуально для текущих данных.
10. Используем описательные статистики для распределений признаков в новой выборке.
```{r}
library(moments)
library(entropy)
```
Вес тела.
```{r}
mean(dfNew$BODY_WEI, na.rm = TRUE)
quantile(dfNew$BODY_WEI, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
var(dfNew$BODY_WEI, na.rm = TRUE)
skewness(dfNew$BODY_WEI, na.rm = TRUE)
kurtosis(dfNew$BODY_WEI, na.rm = TRUE)
```
Вес мозга.
```{r}
mean(dfNew$BRAIN_WE, na.rm = TRUE)
quantile(dfNew$BRAIN_WE, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
var(dfNew$BRAIN_WE, na.rm = TRUE)
skewness(dfNew$BRAIN_WE, na.rm = TRUE)
kurtosis(dfNew$BRAIN_WE, na.rm = TRUE)
```
Медленный сон.
```{r}
mean(dfNew$SLOWWAVE, na.rm = TRUE)
quantile(dfNew$SLOWWAVE, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
var(dfNew$SLOWWAVE, na.rm = TRUE)
skewness(dfNew$SLOWWAVE, na.rm = TRUE)
kurtosis(dfNew$SLOWWAVE, na.rm = TRUE)
```
Быстрый сон.
```{r}
mean(dfNew$PARADOX, na.rm = TRUE)
quantile(dfNew$PARADOX, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
var(dfNew$PARADOX, na.rm = TRUE)
skewness(dfNew$PARADOX, na.rm = TRUE)
kurtosis(dfNew$PARADOX, na.rm = TRUE)
```
Cон.
```{r}
mean(dfNew$SLEEP, na.rm = TRUE)
quantile(dfNew$SLEEP, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
var(dfNew$SLEEP, na.rm = TRUE)
skewness(dfNew$SLEEP, na.rm = TRUE)
kurtosis(dfNew$SLEEP, na.rm = TRUE)
```
Продолжительность жизни.
```{r}
mean(dfNew$LIFESPAN, na.rm = TRUE)
quantile(dfNew$LIFESPAN, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
var(dfNew$LIFESPAN, na.rm = TRUE)
skewness(dfNew$LIFESPAN, na.rm = TRUE)
kurtosis(dfNew$LIFESPAN, na.rm = TRUE)
```
Продолжительность периода вынашивания потомства.
```{r}
mean(dfNew$GESTTIME, na.rm = TRUE)
quantile(dfNew$GESTTIME, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
var(dfNew$GESTTIME, na.rm = TRUE)
skewness(dfNew$GESTTIME, na.rm = TRUE)
kurtosis(dfNew$GESTTIME, na.rm = TRUE)
```

## О виде распределений и о сравнении распределений.
### Индивидуальное задание 2.
1. Проверим распределения признаков на нормальность.
```{r, warning=FALSE, message = FALSE}
library(reshape)
```
Изобразим гистограммы признаков на фоне плотности нормального распределения.
```{r, warning=FALSE, message = FALSE}
dfMelt <- dfNew %>% 
  dplyr::select(-PRED_IND, -DANG_IND) %>% 
  as.data.frame(dfNew) %>% 
  melt(id.vars = c("NAME", "EXP_IND"))

ggplot(dfMelt, aes(x = value)) +
        geom_histogram(aes(y = ..density..)) +
        facet_wrap(~variable, scales = "free") +
        labs(x = "", y = "") +
        geom_line(aes(y = dnorm(value,
                      mean = tapply(value, variable, mean, na.rm = TRUE)[PANEL],
                      sd = tapply(value, variable, sd, na.rm = TRUE)[PANEL]
                      )), color = "blue")
```
Изобразим выборочную функцию распредления признаков на фоне функции 
распределения нормального распределения.
```{r, warning=FALSE, message = FALSE}
ggplot(dfMelt, aes(x = value)) +
        stat_ecdf() +
        facet_wrap(~variable, scales = "free") +
        labs(x = "", y = "") +
        geom_line(aes(y = pnorm(value,
                      mean = tapply(value, variable, mean, na.rm = TRUE)[PANEL],
                      sd = tapply(value, variable, sd, na.rm = TRUE)[PANEL]
                      )), color = "blue")
```
Давайте еще нарисуем PP-plot и QQ-plot.
```{r, warning=FALSE, message = FALSE}
library(qqplotr) 
```

```{r, warning=FALSE, message = FALSE}
ggplot(dfMelt, aes(sample = value)) +
        stat_pp_point(size = 1) +
        facet_wrap(~variable, scales = "free") +
        labs(x = "", y = "") +
        stat_pp_line(color = "blue")
```

```{r, warning=FALSE, message = FALSE}
ggplot(dfMelt, aes(sample = value)) +
        stat_qq_point(size = 1) +
        facet_wrap(~variable, scales = "free") +
        labs(x = "", y = "") +
        stat_qq_line(color = "blue")
```
Похоже, что нормальность имеет место. Проверим это с помощью признаков.
```{r}
library(nortest)
```


Используем критерий Андерсона-Дарлинга, который 
```{r}
ad.test(dfNew$BODY_WEI)
shapiro.test(dfNew$BODY_WEI)
lillie.test(dfNew$BODY_WEI)
```
Нормальность отверглась для быстрого сна. В академических целях используем
менее мощный тест Лиллиефорса, который является модификацией теста
Колмогорова-Смирнова для сложных гипотез.




Используем критерий Колмогорова-Смирнова, так как распределения абсолютно 
непрерывны.
```{r, warning=FALSE, message = FALSE}
ks.test(dfNew$BODY_WEI, "pnorm", mean = mean(dfNew$BODY_WEI, na.rm=TRUE), sd = sd(dfNew$BODY_WEI, na.rm=TRUE))
ks.test(dfNew$BRAIN_WE, "pnorm", mean = mean(dfNew$BRAIN_WE, na.rm=TRUE), sd = sd(dfNew$BRAIN_WE, na.rm=TRUE))
ks.test(dfNew$SLOWWAVE, "pnorm", mean = mean(dfNew$SLOWWAVE, na.rm=TRUE), sd = sd(dfNew$SLOWWAVE, na.rm=TRUE))
ks.test(dfNew$PARADOX, "pnorm", mean = mean(dfNew$PARADOX, na.rm=TRUE), sd = sd(dfNew$PARADOX, na.rm=TRUE))
ks.test(dfNew$SLEEP, "pnorm", mean = mean(dfNew$SLEEP, na.rm=TRUE), sd = sd(dfNew$SLEEP, na.rm=TRUE))
ks.test(dfNew$LIFESPAN, "pnorm", mean = mean(dfNew$LIFESPAN, na.rm=TRUE), sd = sd(dfNew$LIFESPAN, na.rm=TRUE))
ks.test(dfNew$GESTTIME, "pnorm", mean = mean(dfNew$GESTTIME, na.rm=TRUE), sd = sd(dfNew$GESTTIME, na.rm=TRUE))
```
Все тесты не отрицают, что признаки имеют нормальное распределение с уровнем 
значимости 0.5.

### Индивидуальное задание 1. 
Опишем разницу между животными по степени опасности места, где они спят.
```{r, warning=FALSE, message = FALSE}
dfNew %>% ggplot(aes(y=BODY_WEI, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=BRAIN_WE, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=SLOWWAVE, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=PARADOX, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=SLEEP, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=LIFESPAN, colour=EXP_IND)) + geom_boxplot()
dfNew %>% ggplot(aes(y=GESTTIME, colour=EXP_IND)) + geom_boxplot()
```
Можно заметить, что животные живущие в более защищенных местах 1,2) имеют меньший
вес тела и мозга; 3,4,5) чаще дольше спят в общем и в разных фазах сна по отдельности;
6,7) имеют менее длительные продолжительность жизни и период вынашивания потомства. 
Проверим это с помощью критериев.

Давайте проверим наблюдения 1,3) c помощью критериев для животных, живущих
в ниболее и в наименее защищенных местах.
```{r}
dfNew1 <- dplyr::filter(dfNew, EXP_IND == 1)
dfNew5 <- dplyr::filter(dfNew, EXP_IND == 5)

length(dfNew1$NAME)
length(dfNew5$NAME)
```
Ранее мы узнали, что признаки распределены нормально, но сейчас мы будем сравнивать
разные группы индивидов, признаки внутри которых могут уже не имеют нормальность.
Проверим это графически и тестами.
```{r, warning=FALSE, message = FALSE}
ggplot(dfNew1, aes(sample = BODY_WEI)) +
        stat_pp_point(size = 1) +
        labs(x = "", y = "") +
        stat_pp_line(color = "blue")
ggplot(dfNew1, aes(sample = SLEEP)) +
        stat_pp_point(size = 1) +
        labs(x = "", y = "") +
        stat_pp_line(color = "blue")

ggplot(dfNew5, aes(sample = BODY_WEI)) +
        stat_pp_point(size = 1) +
        labs(x = "", y = "") +
        stat_pp_line(color = "blue")
ggplot(dfNew5, aes(sample = SLEEP)) +
        stat_pp_point(size = 1) +
        labs(x = "", y = "") +
        stat_pp_line(color = "blue")
```
По графикам судить трудно. Используем тест Колмогорова-Смирнова.
```{r}
ks.test(dfNew1$BODY_WEI, "pnorm", mean = mean(dfNew1$BODY_WEI, na.rm=TRUE), sd = sd(dfNew1$BODY_WEI, na.rm=TRUE))
ks.test(dfNew1$SLEEP, "pnorm", mean = mean(dfNew1$SLEEP, na.rm=TRUE), sd = sd(dfNew1$SLEEP, na.rm=TRUE))

ks.test(dfNew5$BODY_WEI, "pnorm", mean = mean(dfNew5$BODY_WEI, na.rm=TRUE), sd = sd(dfNew5$BODY_WEI, na.rm=TRUE))
ks.test(dfNew5$SLEEP, "pnorm", mean = mean(dfNew5$SLEEP, na.rm=TRUE), sd = sd(dfNew5$SLEEP, na.rm=TRUE))
```
Тесты не отвергли гипотезу о нормальности признаков внутри групп.

Итак. Группы у нас независимые и  имеют нормальное распределение.

Перед тем как использовать t-тесты нужно узнать, равные ли дисперсии среди групп,
так как у нас есть нормальность используем тест Фишера, который является точным, 
и еще используем тест Левена.
```{r}
var.test(dfNew1$BODY_WEI, dfNew5$BODY_WEI)
var.test(dfNew1$SLEEP, dfNew5$SLEEP)

t.test((dfNew1$BODY_WEI - mean(dfNew1$BODY_WEI, na.rm = TRUE)) * 
         (dfNew1$BODY_WEI - mean(dfNew1$BODY_WEI, na.rm = TRUE)), 
       (dfNew5$BODY_WEI - mean(dfNew5$BODY_WEI, na.rm = TRUE)) * 
         (dfNew5$BODY_WEI - mean(dfNew5$BODY_WEI, na.rm = TRUE)))
t.test((dfNew1$SLEEP - mean(dfNew1$SLEEP, na.rm = TRUE)) * 
         (dfNew1$SLEEP - mean(dfNew1$SLEEP, na.rm = TRUE)), 
       (dfNew5$SLEEP - mean(dfNew5$SLEEP, na.rm = TRUE)) * 
         (dfNew5$SLEEP - mean(dfNew5$SLEEP, na.rm = TRUE)))
```
Для веса дисперсии одинаковые, а для сна нет. 

Посмотрим на t-тесты с равными и неравными дисперсиями.
```{r}
t.test(dfNew1$BODY_WEI, dfNew5$BODY_WEI, var.equal=TRUE, alternative="less")
t.test(dfNew1$SLEEP, dfNew5$SLEEP, var.equal=TRUE, alternative="greate")

t.test(dfNew1$BODY_WEI, dfNew5$BODY_WEI, var.equal=FALSE, alternative="less")
t.test(dfNew1$SLEEP, dfNew5$SLEEP, var.equal=FALSE, alternative="greate")
```
Первый тест точный, второй используется не по назначению, третий и четвертный 
ассимптотические. Как и предполагалось отверглись гипотезы в пользу того, 
что мы наблюдали на box-plot-ах выше.

Воспользуемся непараметрическими t-тестами.
```{r}
wilcox.test(dfNew1$BODY_WEI, dfNew5$BODY_WEI, alternative="less", paired=FALSE)
wilcox.test(dfNew1$SLEEP, dfNew5$SLEEP, alternative="greate", paired=FALSE)
```
Гипотезы так же отверглись.

Наконец используем двухвыборочный тест Колмогорова-Смирнова.
```{r}
ks.test(dfNew1$BODY_WEI, dfNew5$BODY_WEI)
ks.test(dfNew1$SLEEP, dfNew5$SLEEP)
```
Гипотезы так же отверглись.

# Об анализе зависимостей
## Индивидуальное задание 3.
Посмотрим на корреляции между признаками.
```{r, warning=FALSE, message = FALSE}
dplyr::select(dfNew, -NAME) %>%
mutate(PRED_IND = as.numeric(PRED_IND), EXP_IND = as.numeric(EXP_IND), DANG_IND = as.numeric(DANG_IND)) %>%
cor(method = "pearson", use = "pairwise.complete.obs") %>%
melt() %>%
ggplot(aes(X1, X2)) +
  geom_raster(aes(fill = value)) +
  geom_text(aes(label = round(value, 3))) +
  scale_fill_gradient2(low=colors()[555], mid=colors()[1], high=colors()[26]) + 
  ggtitle("dfNew pearson") +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))

dplyr::select(dfNew, -NAME) %>%
mutate(PRED_IND = as.numeric(PRED_IND), EXP_IND = as.numeric(EXP_IND), DANG_IND = as.numeric(DANG_IND)) %>%
cor(method = "spearman", use = "pairwise.complete.obs") %>%
melt() %>%
ggplot(aes(X1, X2)) +
  geom_raster(aes(fill = value)) +
  geom_text(aes(label = round(value, 3))) +
  scale_fill_gradient2(low=colors()[555], mid=colors()[1], high=colors()[26]) + 
  ggtitle("dfNew spearman") +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))
```
Также посчитаем интересные частные корреляции.
```{r, warning=FALSE, message = FALSE}
library(ppcor)
```
Посмотрим на частную корреляцию веса животного и сна за вычетом идексов опасности.
```{r, warning=FALSE, message = FALSE}
((dplyr::select(dfNew, -NAME, -BRAIN_WE, -LIFESPAN, -GESTTIME, -SLOWWAVE, -PARADOX) %>%
  mutate(PRED_IND = as.numeric(PRED_IND), EXP_IND = as.numeric(EXP_IND), DANG_IND = as.numeric(DANG_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>%
as.data.frame())["SLEEP", "BODY_WEI"]

((dplyr::select(dfNew, -NAME, -BRAIN_WE, -LIFESPAN, -GESTTIME, -SLEEP, -PARADOX) %>%
  mutate(PRED_IND = as.numeric(PRED_IND), EXP_IND = as.numeric(EXP_IND), DANG_IND = as.numeric(DANG_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>%
as.data.frame())["SLOWWAVE", "BODY_WEI"]

((dplyr::select(dfNew, -NAME, -BRAIN_WE, -LIFESPAN, -GESTTIME, -SLOWWAVE, -SLEEP) %>%
  mutate(PRED_IND = as.numeric(PRED_IND), EXP_IND = as.numeric(EXP_IND), DANG_IND = as.numeric(DANG_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>%
as.data.frame())["PARADOX", "BODY_WEI"]
```
Посмотрим на частые корреляции индексов опасности животного и сна за вычетом 
веса и связанных с ним критериев.
```{r, warning=FALSE, message = FALSE}
((dplyr::select(dfNew, -NAME, -EXP_IND, -DANG_IND, -SLOWWAVE, -PARADOX) %>%
  mutate(PRED_IND = as.numeric(PRED_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>% 
as.data.frame())["SLEEP", "PRED_IND"]

((dplyr::select(dfNew, -NAME, -EXP_IND, -DANG_IND, -SLEEP, -PARADOX) %>%
  mutate(PRED_IND = as.numeric(PRED_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>% 
as.data.frame())["SLOWWAVE", "PRED_IND"]

((dplyr::select(dfNew, -NAME, -EXP_IND, -DANG_IND, -SLOWWAVE, -SLEEP) %>%
  mutate(PRED_IND = as.numeric(PRED_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>% 
as.data.frame())["PARADOX", "PRED_IND"]
```

```{r, warning=FALSE, message = FALSE}
((dplyr::select(dfNew, -NAME, -PRED_IND, -DANG_IND, -SLOWWAVE, -PARADOX) %>%
  mutate(EXP_IND = as.numeric(EXP_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>% 
as.data.frame())["SLEEP", "EXP_IND"]

((dplyr::select(dfNew, -NAME, -PRED_IND, -DANG_IND, -SLEEP, -PARADOX) %>%
  mutate(EXP_IND = as.numeric(EXP_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>% 
as.data.frame())["SLOWWAVE", "EXP_IND"]

((dplyr::select(dfNew, -NAME, -PRED_IND, -DANG_IND, -SLOWWAVE, -SLEEP) %>%
  mutate(EXP_IND = as.numeric(EXP_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>% 
as.data.frame())["PARADOX", "EXP_IND"]
```

```{r, warning=FALSE, message = FALSE}
((dplyr::select(dfNew, -NAME, -PRED_IND, -EXP_IND, -SLOWWAVE, -PARADOX) %>%
  mutate(DANG_IND = as.numeric(DANG_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>% 
as.data.frame())["SLEEP", "DANG_IND"]

((dplyr::select(dfNew, -NAME, -PRED_IND, -EXP_IND, -SLEEP, -PARADOX) %>%
  mutate(DANG_IND = as.numeric(DANG_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>% 
as.data.frame())["SLOWWAVE", "DANG_IND"]

((dplyr::select(dfNew, -NAME, -PRED_IND, -EXP_IND, -SLOWWAVE, -SLEEP) %>%
  mutate(DANG_IND = as.numeric(DANG_IND)) %>%
  drop_na() %>%
  pcor(method = "spearman"))$estimate %>% 
as.data.frame())["PARADOX", "DANG_IND"]
```




